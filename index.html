<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/PersonalBlog/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/PersonalBlog/css/style.css">

<meta name="generator" content="Hexo 5.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/PersonalBlog/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/PersonalBlog/">Home</a>
        
          <a class="main-nav-link" href="/PersonalBlog/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/PersonalBlog/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-hello-world" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/hello-world/" class="article-date">
  <time datetime="2020-11-30T11:28:45.111Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/hello-world/">Hello World</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/hello-world/" data-id="cki5ye6sr0000i4xv50zm4gbx" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-tip/MyBatis如何实现流式查询" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/tip/MyBatis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/tip/">tip</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/tip/MyBatis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2/">MyBatis如何实现流式查询</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>转自：<a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000022478915">https://segmentfault.com/a/1190000022478915</a></p>
<article class="article fmt article-content" data-id="1190000022478915" data-license="cc">

<h2 id="item-1">基本概念</h2>
<p><strong>流式查询</strong>指的是查询成功后不是返回一个集合而是返回一个迭代器，应用每次从迭代器取一条查询结果。流式查询的好处是能够降低内存使用。</p>
<p>如果没有流式查询，我们想要从数据库取 1000 万条记录而又没有足够的内存时，就不得不分页查询，而分页查询效率取决于表设计，如果设计的不好，就无法执行高效的分页查询。因此流式查询是一个数据库访问框架必须具备的功能。</p>
<p>流式查询的过程当中，数据库连接是保持打开状态的，因此要注意的是：执行一个流式查询后，数据库访问框架就不负责关闭数据库连接了，需要应用在取完数据后自己关闭。</p>
<h2 id="item-2">MyBatis 流式查询接口</h2>
<p>MyBatis 提供了一个叫 <code>org.apache.ibatis.cursor.Cursor</code> 的接口类用于流式查询，这个接口继承了 <code>java.io.Closeable</code> 和 <code>java.lang.Iterable</code> 接口，由此可知：</p>
<ol>
<li>Cursor 是可关闭的；</li>
<li>Cursor 是可遍历的。</li>
</ol>
<p>除此之外，Cursor 还提供了三个方法：</p>
<ol>
<li>
<code>isOpen()</code>：用于在取数据之前判断 Cursor 对象是否是打开状态。只有当打开时 Cursor 才能取数据；</li>
<li>
<code>isConsumed()</code>：用于判断查询结果是否全部取完。</li>
<li>
<code>getCurrentIndex()</code>：返回已经获取了多少条数据</li>
</ol>
<p>因为 Cursor 实现了迭代器接口，因此在实际使用当中，从 Cursor 取数据非常简单：</p>
<pre class="java hljs"><code class="java" style="word-break: break-word; white-space: initial;">cursor.forEach(rowObject -&gt; &#123;...&#125;);</code></pre>
<h2 id="item-3">但构建 Cursor 的过程不简单</h2>
<p>我们举个实际例子。下面是一个 Mapper 类：</p>
<pre class="java hljs"><code class="java"><span class="hljs-meta">@Mapper</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">interface</span> <span class="hljs-title">FooMapper</span> </span>&#123;
    <span class="hljs-meta">@Select</span>(<span class="hljs-string">"select * from foo limit #&#123;limit&#125;"</span>)
    <span class="hljs-function">Cursor&lt;Foo&gt; <span class="hljs-title">scan</span><span class="hljs-params">(@Param(<span class="hljs-string">"limit"</span>)</span> <span class="hljs-keyword">int</span> limit)</span>;
&#125;</code></pre>
<p>方法 scan() 是一个非常简单的查询。通过指定 Mapper 方法的返回值为 Cursor 类型，MyBatis 就知道这个查询方法一个流式查询。</p>
<p>然后我们再写一个 SpringMVC Controller 方法来调用 Mapper（无关的代码已经省略）：</p>
<pre class="java hljs"><code class="java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"foo/scan/0/&#123;limit&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanFoo0</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"limit"</span>)</span> <span class="hljs-keyword">int</span> limit) <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">try</span> (Cursor&lt;Foo&gt; cursor = fooMapper.scan(limit)) &#123;  <span class="hljs-comment">// 1</span>
        cursor.forEach(foo -&gt; &#123;&#125;);                      <span class="hljs-comment">// 2</span>
    &#125;
&#125;</code></pre>
<p>上面的代码中，fooMapper 是 @Autowired 进来的。注释 1 处调用 scan 方法，得到 Cursor 对象并保证它能最后关闭；2 处则是从 cursor 中取数据。</p>
<p>上面的代码看上去没什么问题，但是执行 scanFoo0() 时会报错：</p>
<pre class="hljs css"><code style="word-break: break-word; white-space: initial;"><span class="hljs-selector-tag">java</span><span class="hljs-selector-class">.lang</span><span class="hljs-selector-class">.IllegalStateException</span>: <span class="hljs-selector-tag">A</span> <span class="hljs-selector-tag">Cursor</span> <span class="hljs-selector-tag">is</span> <span class="hljs-selector-tag">already</span> <span class="hljs-selector-tag">closed</span>.</code></pre>
<p>这是因为我们前面说了在取数据的过程中需要保持数据库连接，而 Mapper 方法通常在执行完后连接就关闭了，因此 Cusor 也一并关闭了。</p>
<p>所以，解决这个问题的思路不复杂，保持数据库连接打开即可。我们至少有三种方案可选。</p>
<h3 id="item-3-1">方案一：SqlSessionFactory</h3>
<p>我们可以用 SqlSessionFactory 来手工打开数据库连接，将 Controller 方法修改如下：</p>
<pre class="java hljs"><code class="java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"foo/scan/1/&#123;limit&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanFoo1</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"limit"</span>)</span> <span class="hljs-keyword">int</span> limit) <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">try</span> (
        SqlSession sqlSession = sqlSessionFactory.openSession();  <span class="hljs-comment">// 1</span>
        Cursor&lt;Foo&gt; cursor = 
              sqlSession.getMapper(FooMapper<span class="hljs-class">.<span class="hljs-keyword">class</span>).<span class="hljs-title">scan</span>(<span class="hljs-title">limit</span>)   // 2
    ) </span>&#123;
        cursor.forEach(foo -&gt; &#123; &#125;);
    &#125;
&#125;</code></pre>
<p>上面的代码中，1 处我们开启了一个 SqlSession （实际上也代表了一个数据库连接），并保证它最后能关闭；2 处我们使用 SqlSession 来获得 Mapper 对象。这样才能保证得到的 Cursor 对象是打开状态的。</p>
<h3 id="item-3-2">方案二：TransactionTemplate</h3>
<p>在 Spring 中，我们可以用 TransactionTemplate 来执行一个数据库事务，这个过程中数据库连接同样是打开的。代码如下：</p>
<pre class="java hljs"><code class="java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"foo/scan/2/&#123;limit&#125;"</span>)
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanFoo2</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"limit"</span>)</span> <span class="hljs-keyword">int</span> limit) <span class="hljs-keyword">throws</span> Exception </span>&#123;
    TransactionTemplate transactionTemplate = 
            <span class="hljs-keyword">new</span> TransactionTemplate(transactionManager);  <span class="hljs-comment">// 1</span>

<pre><code>transactionTemplate.execute(status -&amp;gt; &#123;               &lt;span class=&quot;hljs-comment&quot;&gt;// 2&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;try&lt;/span&gt; (Cursor&amp;lt;Foo&amp;gt; cursor = fooMapper.scan(limit)) &#123;
        cursor.forEach(foo -&amp;gt; &#123; &#125;);
    &#125; &lt;span class=&quot;hljs-keyword&quot;&gt;catch&lt;/span&gt; (IOException e) &#123;
        e.printStackTrace();
    &#125;
    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;;
&#125;);</code></pre>
<p>}<br></code></pre></p>
<p>上面的代码中，1 处我们创建了一个 TransactionTemplate 对象（此处 transactionManager 是怎么来的不用多解释，本文假设读者对 Spring 数据库事务的使用比较熟悉了），2 处执行数据库事务，而数据库事务的内容则是调用 Mapper 对象的流式查询。注意这里的 Mapper 对象无需通过 SqlSession 创建。</p>
<h3 id="item-3-3">方案三：@Transactional 注解</h3>
<p>这个本质上和方案二一样，代码如下：</p>
<pre class="java hljs"><code class="java"><span class="hljs-meta">@GetMapping</span>(<span class="hljs-string">"foo/scan/3/&#123;limit&#125;"</span>)
<span class="hljs-meta">@Transactional</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">scanFoo3</span><span class="hljs-params">(@PathVariable(<span class="hljs-string">"limit"</span>)</span> <span class="hljs-keyword">int</span> limit) <span class="hljs-keyword">throws</span> Exception </span>&#123;
    <span class="hljs-keyword">try</span> (Cursor&lt;Foo&gt; cursor = fooMapper.scan(limit)) &#123;
        cursor.forEach(foo -&gt; &#123; &#125;);
    &#125;
&#125;</code></pre>
<p>它仅仅是在原来方法上面加了个 <code>@Transactional</code> 注解。这个方案看上去最简洁，但请注意 Spring 框架当中注解使用的坑：<strong>只在外部调用时生效</strong>。在当前类中调用这个方法，依旧会报错。</p>
<p>以上是三种实现 MyBatis 流式查询的方法。</p></code></pre>

</article>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/tip/MyBatis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2/" data-id="cki5ye6sw0001i4xvbxjq947h" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/tip/" rel="tag">tip</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-algorithm/MaximumGap" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/algorithm/MaximumGap/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/algorithm/">algorithm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/algorithm/MaximumGap/">MaximumGap</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author wangxu</span><br><span class="line"> * date: 2020&#x2F;11&#x2F;26</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 给定一个无序的数组，找出数组在排序之后，相邻元素之间最大的差值。</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 如果数组元素个数小于 2，则返回 0。</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 示例 1:</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 输入: [3,6,9,1]</span><br><span class="line"> * 输出: 3</span><br><span class="line"> * 解释: 排序后的数组是 [1,3,6,9], 其中相邻元素 (3,6) 和 (6,9) 之间都存在最大差值 3。</span><br><span class="line"> * 示例 2:</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 输入: [10]</span><br><span class="line"> * 输出: 0</span><br><span class="line"> * 解释: 数组元素个数小于 2，因此返回 0。</span><br><span class="line"> * 说明:</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 你可以假设数组中所有元素都是非负整数，且数值在 32 位有符号整数范围内。</span><br><span class="line"> * 请尝试在线性时间复杂度和空间复杂度的条件下解决此问题。</span><br><span class="line"> * &lt;p&gt;</span><br><span class="line"> * 来源：力扣（LeetCode）</span><br><span class="line"> * 链接：https:&#x2F;&#x2F;leetcode-cn.com&#x2F;problems&#x2F;maximum-gap</span><br><span class="line"> * 著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</span><br><span class="line"> *&#x2F;</span><br><span class="line">class MaximumGap &#123;</span><br><span class="line">    public int maximumGap(int[] nums) &#123;</span><br><span class="line">        if (nums &#x3D;&#x3D; null || nums.length &lt; 2) &#123;</span><br><span class="line">            return 0;</span><br><span class="line">        &#125;</span><br><span class="line">        if (nums.length &#x3D;&#x3D; 2) &#123;</span><br><span class="line">            return nums[0] &gt; nums[1] ? nums[0] - nums[1] : nums[1] - nums[0];</span><br><span class="line">        &#125;</span><br><span class="line">        int gap &#x3D; 0;</span><br><span class="line">        for (int i &#x3D; 0; i &lt; nums.length; i++) &#123;</span><br><span class="line">            int tmp &#x3D; Integer.MAX_VALUE;</span><br><span class="line">            int subscript &#x3D; i;</span><br><span class="line">            for (int j &#x3D; i; j &lt; nums.length; j++) &#123;</span><br><span class="line">                if (nums[j] &lt; tmp) &#123;</span><br><span class="line">                    tmp &#x3D; nums[j];</span><br><span class="line">                    subscript &#x3D; j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            nums[subscript] &#x3D; nums[i];</span><br><span class="line">            nums[i] &#x3D; tmp;</span><br><span class="line">            gap &#x3D; i &gt; 0 ? Math.max(gap, nums[i] &gt; nums[i - 1] ? nums[i] - nums[i - 1] : nums[i - 1] - nums[i]) : gap;</span><br><span class="line">        &#125;</span><br><span class="line">        return gap;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/algorithm/MaximumGap/" data-id="cki5ye6sy0002i4xv0e171x4t" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/algorithm/" rel="tag">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-algorithm/MoveZeroes" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/algorithm/MoveZeroes/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/algorithm/">algorithm</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/algorithm/MoveZeroes/">MoveZeroes</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;**</span><br><span class="line"> * @author wangxu</span><br><span class="line"> * date: 2020&#x2F;11&#x2F;19</span><br><span class="line"> *</span><br><span class="line"> * 给定一个数组 nums，编写一个函数将所有 0 移动到数组的末尾，同时保持非零元素的相对顺序。</span><br><span class="line"> *</span><br><span class="line"> * 示例:</span><br><span class="line"> *</span><br><span class="line"> * 输入: [0,1,0,3,12]</span><br><span class="line"> * 输出: [1,3,12,0,0]</span><br><span class="line"> * 说明:</span><br><span class="line"> *</span><br><span class="line"> * 必须在原数组上操作，不能拷贝额外的数组。</span><br><span class="line"> * 尽量减少操作次数。</span><br><span class="line"> *</span><br><span class="line"> * 来源：力扣（LeetCode）</span><br><span class="line"> * 链接：https:&#x2F;&#x2F;leetcode-cn.com&#x2F;problems&#x2F;move-zeroes</span><br><span class="line"> * 著作权归领扣网络所有。商业转载请联系官方授权，非商业转载请注明出处。</span><br><span class="line"> *</span><br><span class="line"> *&#x2F;</span><br><span class="line">public class MoveZeroes &#123;</span><br><span class="line">    public void moveZeroes(int[] nums) &#123;</span><br><span class="line">        int i &#x3D; nums.length - 1;</span><br><span class="line">        for (; i &gt;&#x3D; 0; i--) &#123;</span><br><span class="line">            int numi &#x3D; nums[i];</span><br><span class="line">            if (numi &#x3D;&#x3D; 0) &#123;</span><br><span class="line">                for (int j &#x3D; i + 1; j &lt; nums.length &amp;&amp; nums[j] !&#x3D; 0; j++) &#123;</span><br><span class="line">                    int tmp &#x3D; nums[j - 1];</span><br><span class="line">                    nums[j - 1] &#x3D; nums[j];</span><br><span class="line">                    nums[j] &#x3D; tmp;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/algorithm/MoveZeroes/" data-id="cki5ye6t10005i4xv54a04tb8" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/algorithm/" rel="tag">algorithm</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-review/Java11 Api Document/1. Java® Platform, Standard Edition &amp; Java Development Kit Version 11 API Specification" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/review/Java11%20Api%20Document/1.%20Java%C2%AE%20Platform,%20Standard%20Edition%20&%20Java%20Development%20Kit%20Version%2011%20API%20Specification/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/review/">review</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/review/Java11%20Api%20Document/1.%20Java%C2%AE%20Platform,%20Standard%20Edition%20&%20Java%20Development%20Kit%20Version%2011%20API%20Specification/">1. Java® Platform, Standard Edition &amp; Java Development Kit Version 11 API Specification</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/docs/api/index.html">https://docs.oracle.com/en/java/javase/11/docs/api/index.html</a></p>
<p>文章标题《Java SE和JDK 11 API说明书》</p>
<p>API说明文档主要分成两部分：Java SE、JDK。</p>
<ul>
<li>Java SE：Java平台标准版(Java SE) api定义了用于通用计算的核心Java平台。这些api位于名称以java开头的模块中。</li>
<li>JDK：Java开发工具包(JDK) api是特定于JDK的，并不一定在Java SE平台的所有实现中都可用。这些api位于名称以jdk开头的模块中。</li>
</ul>
<p>Java SE</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>java.base</td>
<td>定义了Java SE的基础API</td>
</tr>
<tr>
<td>java.compiler</td>
<td>定义了语言模型、注释处理和Java编译器API</td>
</tr>
<tr>
<td>java.datatransfer</td>
<td>定义用于在应用程序之间和应用程序内部传输数据的API</td>
</tr>
<tr>
<td>java.desktop</td>
<td>定义了AWT和Swing用户界面工具包，以及用于可访问性、音频、图像处理、打印和javabean的api</td>
</tr>
<tr>
<td>java.instrument</td>
<td>定义允许代理检测运行在JVM上的程序的服务</td>
</tr>
<tr>
<td>java.logging</td>
<td>定义了Java日志API</td>
</tr>
<tr>
<td>java.management</td>
<td>定义Java管理扩展(JMX) API</td>
</tr>
<tr>
<td>java.management.rmi</td>
<td>为Java管理扩展(JMX)远程API定义RMI连接器</td>
</tr>
<tr>
<td>java.naming</td>
<td>定义Java命名和目录接口(JNDI) API</td>
</tr>
<tr>
<td>java.net.http</td>
<td>定义HTTP客户端和WebSocket api</td>
</tr>
<tr>
<td>java.prefs</td>
<td>定义首选项API</td>
</tr>
<tr>
<td>java.rmi</td>
<td>远程方法调用(RMI) API</td>
</tr>
<tr>
<td>java.scripting</td>
<td>定义脚本API</td>
</tr>
<tr>
<td>java.se</td>
<td>定义Java SE平台的API</td>
</tr>
<tr>
<td>java.security.jgss</td>
<td>定义IETF通用安全服务API (GSS-API)的Java绑定</td>
</tr>
<tr>
<td>java.security.sasl</td>
<td>定义对IETF简单身份验证和安全层(SASL)的Java支持</td>
</tr>
<tr>
<td>java.sql</td>
<td>定义JDBC API</td>
</tr>
<tr>
<td>java.sql.rowset</td>
<td>定义JDBC RowSet API</td>
</tr>
<tr>
<td>java.transaction.xa</td>
<td>在JDBC中定义支持分布式事务的API</td>
</tr>
<tr>
<td>java.xml</td>
<td>定义用于XML处理的Java API (JAXP)、用于XML的流API (StAX)、用于XML的简单API (SAX)和W3C文档对象模型(DOM) API</td>
</tr>
<tr>
<td>java.xml.crypto</td>
<td>为XML加密定义API</td>
</tr>
</tbody></table>
<p>JDK</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>jdk.accessibility</td>
<td>定义辅助技术的实现者使用的JDK实用程序类</td>
</tr>
<tr>
<td>jdk.attach</td>
<td>定义附加API</td>
</tr>
<tr>
<td>jdk.charsets</td>
<td>提供java.base中没有的字符集(主要是双字节和IBM字符集)</td>
</tr>
<tr>
<td>jdk.compiler</td>
<td>定义系统Java编译器的实现和它的命令行对等物javac</td>
</tr>
<tr>
<td>jdk.crypto.cryptoki</td>
<td>提供SunPKCS11安全提供程序的实现</td>
</tr>
<tr>
<td>jdk.crypto.ec</td>
<td>提供SunEC安全提供程序的实现</td>
</tr>
<tr>
<td>jdk.dynalink</td>
<td>定义用于对象上高级操作的动态链接的API。</td>
</tr>
<tr>
<td>jdk.editpad</td>
<td>提供jdk.jshell使用的编辑垫服务的实现</td>
</tr>
<tr>
<td>jdk.hotspot.agent</td>
<td>定义HotSpot可服务性代理的实现。</td>
</tr>
<tr>
<td>jdk.httpserver</td>
<td>定义特定于jdk的HTTP服务器API。</td>
</tr>
<tr>
<td>jdk.jartool</td>
<td>定义用于操作Java归档(JAR)文件的工具，包括JAR和jarsigner工具</td>
</tr>
<tr>
<td>jdk.javadoc</td>
<td>定义系统文档工具和它的命令行对等物javadoc的实现</td>
</tr>
<tr>
<td>jdk.jcmd</td>
<td>定义用于诊断和排除JVM故障的工具，如jcmd、jps和jstat工具</td>
</tr>
<tr>
<td>jdk.jconsole</td>
<td>定义用于监视和管理运行中的应用程序的JMX图形化工具jconsole</td>
</tr>
<tr>
<td>jdk.jdeps</td>
<td>定义用于分析Java库和程序中的依赖关系的工具，包括jdeps、javap和jdeprscan工具</td>
</tr>
<tr>
<td>jdk.jdi</td>
<td>定义Java调试接口。</td>
</tr>
<tr>
<td>jdk.jdwp.agent</td>
<td>提供Java调试连线协议(JDWP)代理的实现</td>
</tr>
<tr>
<td>jdk.jfr</td>
<td>为JDK飞行记录器定义API</td>
</tr>
<tr>
<td>jdk.jlink</td>
<td>定义用于创建运行时映像的jlink工具、用于创建和操作jmod文件的jmod工具，以及用于检查特定于JDK实现的容器文件(用于类和资源)的jimage工具</td>
</tr>
<tr>
<td>jdk.jshell</td>
<td>这个模块提供了对Java编程语言“代码片段”计算工具的支持，例如Read-Eval-Print循环(REPLs)，包括jshell工具</td>
</tr>
<tr>
<td>jdk.jsobject</td>
<td>为JavaScript对象定义API</td>
</tr>
<tr>
<td>jdk.jstatd</td>
<td>定义用于为jstat工具启动守护进程的jstatd工具，以远程监视JVM统计信息</td>
</tr>
<tr>
<td>jdk.localedata</td>
<td>为美国地区以外的地区提供地区数据</td>
</tr>
<tr>
<td>jdk.management</td>
<td>为JVM定义特定于jdk的管理接口</td>
</tr>
<tr>
<td>jdk.management.agent</td>
<td>定义JMX管理代理</td>
</tr>
<tr>
<td>jdk.management.jfr</td>
<td>定义JDK飞行记录器的管理接口</td>
</tr>
<tr>
<td>jdk.naming.dns</td>
<td>提供DNS Java命名提供程序的实现</td>
</tr>
<tr>
<td>]jdk.naming.rmi</td>
<td>提供RMI Java命名提供程序的实现</td>
</tr>
<tr>
<td>jdk.net</td>
<td>定义特定于jdk的网络API</td>
</tr>
<tr>
<td>jdk.pack</td>
<td>定义用于将JAR文件转换为压缩的pack200文件和将打包的文件转换为JAR文件的工具，包括pack200和unpack200工具</td>
</tr>
<tr>
<td>jdk.rmic</td>
<td>定义rmic编译器，用于使用远程对象的Java远程方法协议(JRMP)生成存根和骨架</td>
</tr>
<tr>
<td>jdk.scripting.nashorn</td>
<td>为ECMAScript 5.1编写的程序提供了Nashorn脚本引擎的实现和运行时环境</td>
</tr>
<tr>
<td>jdk.sctp</td>
<td>为SCTP定义特定于jdk的API</td>
</tr>
<tr>
<td>jdk.security.auth</td>
<td>提供javax.security.auth.*接口的实现和各种身份验证模块。</td>
</tr>
<tr>
<td>jdk.security.jgss</td>
<td>定义GSS-API的JDK扩展和SASL GSSAPI机制的实现</td>
</tr>
<tr>
<td>jdk.xml.dom</td>
<td>定义不属于Java SE API的W3C文档对象模型(DOM) API的子集</td>
</tr>
<tr>
<td>jdk.zipfs</td>
<td>提供zip文件系统提供程序的实现</td>
</tr>
</tbody></table>
<p>其他模块</p>
<table>
<thead>
<tr>
<th>模块</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>java.smartcardio</td>
<td>定义Java智能卡I/O API</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/review/Java11%20Api%20Document/1.%20Java%C2%AE%20Platform,%20Standard%20Edition%20&%20Java%20Development%20Kit%20Version%2011%20API%20Specification/" data-id="cki5ye6t20006i4xvh16c436e" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/review/" rel="tag">review</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-review/Java11 Api Document/2. Module java.base packages" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/review/Java11%20Api%20Document/2.%20Module%20java.base%20packages/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/review/">review</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/review/Java11%20Api%20Document/2.%20Module%20java.base%20packages/">2. Module java.base packages</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文链接：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/module-summary.html">https://docs.oracle.com/en/java/javase/11/docs/api/java.base/module-summary.html</a></p>
<p>定义了Java SE平台的基础API。</p>
<ul>
<li>提供的功能：<br>这个模块的JDK实现提供了jrt文件系统提供程序的实现，用于枚举和读取运行时映像中的类和资源文件。可以通过调用FileSystems.newFileSystem(URI.create(“jrt:/“))来创建jrt文件系统。</li>
<li>工具指南：<a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/java.html#GUID-3B1CE181-CD30-4178-9602-230B800D4FAE">java launcher</a>, <a target="_blank" rel="noopener" href="https://docs.oracle.com/en/java/javase/11/tools/keytool.html">keytool</a></li>
<li>模块图：<br><img src="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/module-graph.png" alt="image"></li>
<li>从Java9开始</li>
</ul>
<h3 id="下属包"><a href="#下属包" class="headerlink" title="下属包"></a>下属包</h3><table>
<thead>
<tr>
<th>包名</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>java.io</td>
<td>通过数据流、序列化和文件系统的方式为系统提供了输入输出</td>
</tr>
<tr>
<td>java.lang</td>
<td>提供Java编程语言设计的基础类</td>
</tr>
<tr>
<td>java.lang.annotation</td>
<td>为Java编程语言注释工具提供了库支持</td>
</tr>
<tr>
<td>java.lang.invoke</td>
<td>该包为与jvm通讯提供了低级原语</td>
</tr>
<tr>
<td>java.lang.module</td>
<td>提供了一些用来支持模块描述符并通过解析和服务绑定创建模块配置的类</td>
</tr>
<tr>
<td>java.lang.ref</td>
<td>提供引用对象类，这些类支持与垃圾收集器进行有限程度的交互</td>
</tr>
<tr>
<td>java.lang.reflect</td>
<td>提供类和接口，以获取关于类和对象的反射信息</td>
</tr>
<tr>
<td>java.math</td>
<td>提供用于执行任意精度整数算术(BigInteger)和任意精度十进制算术(BigDecimal)的类</td>
</tr>
<tr>
<td>java.net</td>
<td>提供用于实现网络应用的类</td>
</tr>
<tr>
<td>java.net.spi</td>
<td>java.net包的服务提供类</td>
</tr>
<tr>
<td>java.nio</td>
<td>定义缓冲区，缓冲区是数据的容器，并提供其他NIO包的概述</td>
</tr>
<tr>
<td>java.nio.channels</td>
<td>定义通道，它表示与能够执行I/O操作的实体的连接，例如文件和套接字;定义选择器，用于多路复用，非阻塞I/O操作</td>
</tr>
<tr>
<td>java.nio.channels.spi</td>
<td>java.nio.channels包的服务提供类</td>
</tr>
<tr>
<td>java.nio.charset</td>
<td>定义字符集、解码器和编码器，用于在字节和Unicode字符之间转换</td>
</tr>
<tr>
<td>java.nio.charset.spi</td>
<td>java.nio.charset包的服务提供类</td>
</tr>
<tr>
<td>java.nio.file</td>
<td>为jvm定义了访问文件、文件属性、文件系统的接口和类</td>
</tr>
<tr>
<td>java.nio.file.attribute</td>
<td>提供访问文件和文件系统属性的接口和类</td>
</tr>
<tr>
<td>java.nio.file.spi</td>
<td>java.nio.file包的服务提供类</td>
</tr>
<tr>
<td>java.security</td>
<td>为安全框架提供了类和接口</td>
</tr>
<tr>
<td>java.security.acl</td>
<td>这个包下的接口和类废弃了</td>
</tr>
<tr>
<td>java.security.cert</td>
<td>提供用于解析和管理证书、证书撤销列表和证书路径的类和接口</td>
</tr>
<tr>
<td>java.security.interfaces</td>
<td>提供接口为生成RSA (Rivest, Shamir和Adleman非对称密码算法)密钥定义在RSA实验室技术说明PKCS#1，和DSA(数字签名算法)密钥定义在NIST的FIPS-186</td>
</tr>
<tr>
<td>java.security.spec</td>
<td>为关键规范和算法参数规范提供类和接口</td>
</tr>
<tr>
<td>java.text</td>
<td>提供以独立于自然语言的方式处理文本、日期、数字和消息的类和接口</td>
</tr>
<tr>
<td>java.text.spi</td>
<td>java.text包的服务提供类</td>
</tr>
<tr>
<td>java.time</td>
<td>用于日期、时间、时间戳、时间段的API</td>
</tr>
<tr>
<td>java.time.chrono</td>
<td>日历的的通用API，而不是默认的ISO</td>
</tr>
<tr>
<td>java.time.format</td>
<td>通了用于打印和解析日期和时间的类</td>
</tr>
<tr>
<td>java.time.temporal</td>
<td>使用字段和单元以及日期时间调整器访问日期和时间</td>
</tr>
<tr>
<td>java.time.zone</td>
<td>支持时区和时区规则</td>
</tr>
<tr>
<td>java.util</td>
<td>包含集合框架、一些国际化支持类、一个服务加载器、属性、随机数生成、字符串解析和扫描类、base64编码和解码、一个位数组和几个杂项实用程序类</td>
</tr>
<tr>
<td>java.util.concurrent</td>
<td>在并发编程中通常有用的实用程序类</td>
</tr>
<tr>
<td>java.util.concurrent.atomic</td>
<td>一个小的类工具包，支持在单个变量上进行无锁线程安全编程</td>
</tr>
<tr>
<td>java.util.concurrent.locks</td>
<td>接口和类提供了用于锁定和等待条件的框架，这与内置的同步和监视器不同</td>
</tr>
<tr>
<td>java.util.function</td>
<td>函数接口为lambda表达式和方法引用提供了目标类型</td>
</tr>
<tr>
<td>java.util.jar</td>
<td>提供用于读写JAR (Java归档)文件格式的类，该格式基于带有可选清单文件的标准ZIP文件格式</td>
</tr>
<tr>
<td>java.util.regex</td>
<td>用于根据正则表达式指定的模式匹配字符序列的类</td>
</tr>
<tr>
<td>java.util.spi</td>
<td>java.util包下的服务提供类</td>
</tr>
<tr>
<td>java.util.stream</td>
<td>支持对元素流的进行函数式操作的类，例如对集合的map-reduce转换。</td>
</tr>
<tr>
<td>java.util.zip</td>
<td>提供了用于读写标准ZIP和GZIP文件格式的类</td>
</tr>
<tr>
<td>javax.crypto</td>
<td>提供用于加密操作的类和接口</td>
</tr>
<tr>
<td>javax.crypto.interfaces</td>
<td>在RSA实验室的PKCS #3中定义为diffee - hellman密钥提供接口</td>
</tr>
<tr>
<td>javax.crypto.spec</td>
<td>为关键规范和算法参数规范提供类和接口</td>
</tr>
<tr>
<td>javax.net</td>
<td>为网络应用提供类</td>
</tr>
<tr>
<td>javax.net.ssl</td>
<td>为安全套接字包提供类</td>
</tr>
<tr>
<td>javax.security.auth</td>
<td>这个包为身份验证和授权提供了一个框架</td>
</tr>
<tr>
<td>javax.security.auth.callback</td>
<td>这个包提供了服务与应用程序交互所需的类，以便检索信息(例如，包括用户名或密码在内的身份验证数据)或显示信息(例如，错误和警告消息)</td>
</tr>
<tr>
<td>javax.security.auth.login</td>
<td>这个包提供了一个可插入的身份验证框架</td>
</tr>
<tr>
<td>javax.security.auth.spi</td>
<td>这个包提供了用于实现可插拔身份验证模块的接口</td>
</tr>
<tr>
<td>javax.security.auth.x500</td>
<td>这个包包含应该用于在一个主题中存储X500主体凭证和X500私有凭证的类</td>
</tr>
<tr>
<td>javax.security.cert</td>
<td>提供用于公钥证书的类</td>
</tr>
</tbody></table>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/review/Java11%20Api%20Document/2.%20Module%20java.base%20packages/" data-id="cki5ye6t30007i4xv6x1m5dhu" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/review/" rel="tag">review</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tip/Mysql索引精讲" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/tip/Mysql%E7%B4%A2%E5%BC%95%E7%B2%BE%E8%AE%B2/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/tip/">tip</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/tip/Mysql%E7%B4%A2%E5%BC%95%E7%B2%BE%E8%AE%B2/">MySQL索引精讲</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>转自：<a target="_blank" rel="noopener" href="https://www.cnblogs.com/wyc1994666/p/10831039.html">https://www.cnblogs.com/wyc1994666/p/10831039.html</a></p>
<div id="cnblogs_post_body" class="blogpost-body cnblogs-markdown">
    <p>开门见山，直接上图，下面的思维导图即是现在要讲的内容，可以先有个印象～<br>
<img src="https://user-gold-cdn.xitu.io/2019/5/7/16a8e1013eaca9df?w=2558&amp;h=1568&amp;f=png&amp;s=928195" alt="" loading="lazy"></p>
<ul>
<li>常见索引类型(实现层面)</li>
<li>索引种类(应用层面)</li>
<li>聚簇索引与非聚簇索引</li>
<li>覆盖索引</li>
<li>最佳索引使用策略</li>
</ul>
<h3 id="1常见索引类型实现层面">1.常见索引类型(实现层面)</h3>
<p>首先不谈Mysql怎么实现索引的,先马后炮一下,如果让我们来设计数据库的索引，该怎么设计？</p>
<p>我们首先思考一下索引到底想达到什么效果？其实就是想能够实现<strong>快速查找</strong>数据的策略，所以索引的实现本质上就是一个<strong>查找算法</strong>。</p>
<p>但是跟普通的查找有所不同，因为我们的数据有一下特征：</p>
<p><strong>1.存储的数据是非常非常多的</strong><br>
<strong>2.并且还不断的动态变化</strong></p>
<p>所以实现索引时需要考虑到这两个特点。我们需要找一个最合适的数据结构算法来实现查找功能。</p>
<p>下面一起看下常见的查找策略，如下图：</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a8e060ef3e0be7?w=1528&amp;h=670&amp;f=png&amp;s=269172" alt="" loading="lazy"></p>
<p>由于前面说的两个特点我们首先排除静态查找的算法。</p>
<p>至于查找树，我们有二叉树和多叉树两种选择：</p>
<p><strong>二叉树</strong>：如果先泽二叉树的话，由于我们的数据量庞大，二叉树的深度会变得非常大，我们的索引树会变成参天大树，每次查询会导致很多磁盘IO。</p>
<p><strong>多叉树</strong>：多叉树解决了了树的深度大的问题，那么我们到底选择B树还是B+树呢？</p>
<blockquote>
<p>B树 摘自维基百科 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/B%2B%E6%A0%91">https://zh.wikipedia.org/wiki/B%2B树</a></p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a8e338a78da687?w=410&amp;h=147&amp;f=png&amp;s=64361" alt="" loading="lazy"></p>
<blockquote>
<p>B+树 摘自维基百科 <a target="_blank" rel="noopener" href="https://zh.wikipedia.org/wiki/B%2B%E6%A0%91">https://zh.wikipedia.org/wiki/B%2B树</a></p>
</blockquote>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a8e34453c8dc99?w=404&amp;h=222&amp;f=png&amp;s=70708" alt="" loading="lazy"></p>
<p>从上面图可知<strong>B+树的叶子节点存放了所有的索引值</strong>，并且叶子结点之间以链表的形式相互关联，所以我们只需从最左的链表遍历的话即可查找所有的值，最常见的用途就是范围查找，而B树则不满足这范围查找，又或者说实现特别复杂,所以Mysql最终选择了使用B+树实现这一功能。</p>
<h4 id="11-b-tree-索引b树">1.1 B-Tree 索引(B+树)</h4>
<p>先说明一下，虽然叫在Mysql官方叫做B-Tree索引，但采用的是B+树数据结构。</p>
<p>B-tree索引能够加快访问数据的速度，不需要进行全表扫描，而是从索引树的根节点层层往下搜索，在根节点存放了索引值和指向下一个节点的指针。</p>
<p>下面看下单列索引的数据怎么组织的。</p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 <span class="hljs-keyword">key</span>(<span class="hljs-string">`uid`</span>)
);

<p></code></pre></p>
<p>上面User 表给uid列创建了一个索引，那么往表里插入uid(96~102)的时候存储引擎是怎么管理索引的呢？看下面的索引树</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a90f6429729ea5?w=2712&amp;h=1416&amp;f=png&amp;s=251647" alt="" loading="lazy"></p>
<p><strong>1.在叶子节点存放所有的索引值，非叶子节点值是为了更快定位包含目标值的叶子节点</strong></p>
<p><strong>2.叶子节点的值是有序的</strong></p>
<p><strong>3.叶子节点之间以链表形式关联</strong></p>
<p>下面在看一下多列(联合)索引的数据怎么组织的。</p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 <span class="hljs-keyword">key</span>(<span class="hljs-string">`uid`</span>,<span class="hljs-string">`name`</span>)
);

<p></code></pre></p>
<p>给User 表创建了联合索引 key(<code>uid</code>,<code>name</code>) 这种情况下他的索引树是如下图所示。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a910ec9b346060?w=2764&amp;h=1544&amp;f=png&amp;s=286716" alt="" loading="lazy"></p>
<p>特点跟单列索引一样，不同之处在于他的排序，<strong>如果第一个字段相同时会按第二个索引字段排序</strong></p>
<p><strong>如何通过B-tree快速查找数据？</strong></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/8/16a955c0a7dfb0f0?w=2464&amp;h=1764&amp;f=png&amp;s=1212349" alt="" loading="lazy"></p>
<p>对于InnoDb 存储引擎的B-tree索引，会按一下步骤通过索引找到行数据</p>
<ul>
<li>如果使用了聚簇索引(主键)，则叶子节点上就包含行数据，可直接返回</li>
<li>如果使用了非聚簇索引(普通索引),则在叶子节点存了主键，再根据主键查询一次上面<br>
的聚簇索引，最后返回数据</li>
</ul>
<p>对于MyISAM 存储引擎的B-tree索引，会按一下步骤通过索引找到行数据</p>
<ul>
<li>在MyISAM 的索引树的叶子节点上除了索引值之外即没存储主键，也没存储行数据，而是存了指向行数据的指针，根据这个指针在从表文件查询数据。</li>
</ul>
<h4 id="12-hash-索引哈希表">1.2 Hash 索引(哈希表)</h4>
<p>哈希索引是基于哈希表来实现的，只有精确匹配所有的所有列才能生效。</p>
<p>也就是说假设有个hash索引 key (col1,col2) 那么每次只有 col1和col2两个字段都用才能够生效。因为生成hash索引的时候是根据一个hash函数对所有的索引列取hash值来实现的。</p>
<p>如下方图，有个hash索引key(name)</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a91361395c1d67?w=3704&amp;h=1192&amp;f=png&amp;s=381171" alt="" loading="lazy"></p>
<p>当我们执行 <code>mysql&gt; select * from User where name='张三'；</code> 时怎么利用hash索引快速查找的？</p>
<ol>
<li>第一步，计算出hash值，hash(张三) = 1287</li>
<li>第二步，定位行号，比如key=1287 对应的行号为3</li>
<li>第三步，找到指定行并且比较name列值是否为张三做个校验</li>
</ol>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a914bbdf8f546a?w=3084&amp;h=1636&amp;f=png&amp;s=841469" alt="" loading="lazy"></p>
<h3 id="2常见索引种类应用层面">2.常见索引种类(应用层面)</h3>
<p><strong>主键索引</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 primary <span class="hljs-keyword">key</span>(<span class="hljs-string">`uid`</span>)
);
</code></pre>
<p>主键索引是唯一的，通常以表的ID设置为主键索引,一个表只能有一个主键索引，这是他跟唯一索引的区别。</p>
<p><strong>唯一索引</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 <span class="hljs-keyword">unique</span> <span class="hljs-keyword">key</span>(<span class="hljs-string">`name`</span>)
);
</code></pre>
<p>唯一索引主要用于业务上的唯一约束，他跟主键索引的区别是，一个表可以有多个唯一索引</p>
<p><strong>单列索引</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 <span class="hljs-keyword">key</span>(<span class="hljs-string">`name`</span>)
);
</code></pre>
<p>以某一个字段为索引</p>
<p><strong>联合索引</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 <span class="hljs-keyword">key</span>(<span class="hljs-string">`name`</span>,<span class="hljs-string">`uid`</span>)
);
</code></pre>
<p>两个或两个以上字段联合组成一个索引。使用时需要注意满足最左匹配原则！</p>
<p>还有其他不常用的就不介绍了～</p>
<h3 id="3聚簇索引与非聚簇索引">3.聚簇索引与非聚簇索引</h3>
<p>什么是聚簇索引？<br>
聚簇索引指的是他的 <strong>索引和行数据</strong> 在一起存储。也就是在一颗B+树的叶子结点上存储的不仅是他的索引值，还有对应的某一行的数据。待会儿看图便知。</p>
<p><strong>聚簇索引不是一种索引，而是一种数据存储组织方式 ！！！</strong></p>
<pre><code class="hljs lisp">crreate table test(
  <span class="hljs-name">col1</span> int not null,
  col2 int not null,
  PRIMARY KEY(<span class="hljs-name">col1</span>),
  KEY(<span class="hljs-name">col2</span>)
)<span class="hljs-comment">;</span>

<p></code></pre></p>
<p>如上所示，表test 由两个索引，分别是主键 col1 和 普通索引 col2。那么这俩索引跟聚簇非聚簇有啥关系呢？</p>
<p>会生成一个聚簇索引和一个非聚簇索引(二级索引)，也就是说会组织两个索引树。主键索引会生成聚簇索引的树 以及以col2为索引的非聚簇索引的树。</p>
<p><strong>InnoDb 将通过主键来实现聚簇索引</strong> ，如果没有主键则会选选一个唯一非空索引来实现。如果没有唯一非空索引则会隐式生成一个主键。</p>
<p>下面看下聚簇索引和非聚簇索引在索引树上数据是怎么分布的，图片摘自《高性能Nysql》</p>
<p><strong>下图是聚簇索引的数据组织方式。 col1为主键索引的聚簇索引树</strong></p>
<p><strong>索引列是主键 col1</strong><br>
<img src="https://user-gold-cdn.xitu.io/2019/5/7/16a91a63ccf42d68?w=2280&amp;h=1012&amp;f=png&amp;s=608573" alt="" loading="lazy"><br>
可以看出叶子结点除了存储索引值 列col1 (3<sub>99</sub>4700)值 之外还存储了其他列的值，如列col2 (92<sub>8</sub>13),如果还有别的列的话也会存储，或者换句话说聚簇索引树 在叶子节点上存储某个索引值对应的一行数据。</p>
<p><strong>下图是非聚簇索引(二级索引)的数据组织方式。</strong></p>
<p><strong>索引列是 col2</strong></p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/7/16a91a6b2cda599c?w=2300&amp;h=816&amp;f=png&amp;s=476965" alt="" loading="lazy"></p>
<p>与聚簇索引不同的是非聚簇索引在索引树叶子节点上除了索引值之外只存了主键值。而聚簇索引则存了一行数据。</p>
<p><font color="red"></font><br>
假如有一条sql 语句 <code>select * from test where col2=93;</code><br>
上面这条语句会经历两次从索引树查找过程</p>
<p>1.第一步从非聚簇索引的索引树上找到包含col2=93的叶子节点，并定位到行的主键 3<br>
2.第二步 根据主键 3 在从聚簇索引定位包含 主键=3的叶子节点并返回全部行数据。</p>
<p>以上说的都是基于InnoDb存储引擎的,<strong>MyISAM</strong>是不支持聚簇索引的，因为他的数据文件和索引文件是相互独立存储的  <strong>MyISAM</strong>存储引擎的索引树的叶子节点不会寸主键值，而存一个指向对应行的地址或者说是指针，然后再从表数据文件里去找，如下面图所示。</p>
<p><img src="https://user-gold-cdn.xitu.io/2019/5/8/16a930d08635644c?w=1348&amp;h=1072&amp;f=png&amp;s=558635" alt="" loading="lazy"></p>
<p><font color="red"> 结论：</font></p>
<ul>
<li>
<p>聚簇索引:<br>
通常由主键或者非空唯一索引实现的，叶子节点存储了一整行数据</p>
</li>
<li>
<p>非聚簇索引：<br>
又称二级索引，就是我们常用的普通索引，叶子节点存了索引值和主键值，在根据主键从聚簇索引查</p>
</li>
</ul>
<h3 id="4覆盖索引">4.覆盖索引</h3>
<p><strong>覆盖索引就是指索引包含了所有需要查询的字段。</strong></p>
<pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> <span class="hljs-keyword">User</span>(
<span class="hljs-string">`name`</span> <span class="hljs-built_in">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`uid`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">4</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
<span class="hljs-string">`gender`</span> <span class="hljs-built_in">int</span>(<span class="hljs-number">2</span>) <span class="hljs-keyword">not</span> <span class="hljs-literal">null</span>,
 <span class="hljs-keyword">key</span>(<span class="hljs-string">`uid`</span>,<span class="hljs-string">`name`</span>)
);

<p></code></pre></p>
<p>假如表 User有三个字段 User (name,uid,gender),且有个联合索引 key(name,uid)那么<br>
执行如下面这条sql查询时就用到了 覆盖索引。</p>
<p><code> select name,uid from User where name in ('a','b') and uid &gt;= 98 and uid &lt;=100 ;</code></p>
<p>上面这条sql语句使用了联合索引 key(name,uid),并且只需查找 name,uid两个字段，所以使用了覆盖索引。覆盖索引有什么好处呢？先看一下下面这个图<br>
<img src="https://user-gold-cdn.xitu.io/2019/5/7/16a910ec9b346060?w=2764&amp;h=1544&amp;f=png&amp;s=286716" alt="" loading="lazy"><br>
上面这个图就是 联合索引key(name,uid) 所对应的索引树，从图中可以看出，如果我们只需查询(name,uid)两个字段的话，从索引树就能得到我们需要查的数据。不需要找到索引值之后再从表数据文件定位对应的行数据了。</p>
<p>覆盖索引好处<br>
1.避免了对主键索引(聚簇)的二次查询<br>
2.由于不需要回表查询(从表数据文件)所以大大提升了Mysql缓存的负载</p>
<p>总之大大提升了读取数据的性能</p>
<h3 id="5最佳索引使用策略">5.最佳索引使用策略</h3>
<p>最后在讲讲使用索引过程中的避坑指南</p>
<p><strong>独立的列</strong></p>
<p>独立的列不是指单列索引，而是指<font color="red">索引列不能是表达式的一部分或者是函数的一部分</font>。</p>
<p>select * FROM test where col1 + 1 =100;  // 不能是表达式一部分</p>
<p>select * FROM test where ABS(col1) =100;  // 不能是函数一部分</p>
<p><strong>最左匹配原则</strong></p>
<p>假如有个联合索引 key (col1,col2)。那么一下查询是索引无效的</p>
<p>select * from test where col2 = 3;</p>
<p>select * from test where col1 like '%3';</p>
<p>对于最左匹配原则，大家想一下B+树的叶子节点的关联就差不多知道为啥需要最左匹配原则了，因为B+的叶子结点，从左到右以链表的形式关联的，索引我们查询的时候要么范围查询，要么有明确的左边一个开始的索引值，不能跳过或者不明确如 like '%XYZ'这种查询。</p>
<p><strong>索引值不能是null值</strong></p>
<p>单列索引有null值会导致索引无效<br>
多列索引只要有个列有null值会导致索引无效</p>
<p><strong>使用聚簇索引和覆盖索引大大提升读取性能</strong></p>
<p>因为聚簇索引和覆盖索引的索引树上就有了需要的字段，所以不需要回表文件查询，所以提升了查询速度</p>
<p><strong>使用短索引</strong><br>
如果很长的字符串进行查询，只需匹配一个前缀长度，这样能够节省大量索引空间</p>

</div>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/tip/Mysql%E7%B4%A2%E5%BC%95%E7%B2%BE%E8%AE%B2/" data-id="cki5ye6tb000qi4xvfblc9aoa" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/tip/" rel="tag">tip</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tip/短URL服务的设计以及实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/tip/%E7%9F%ADURL%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E5%AE%9E%E7%8E%B0/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/tip/">tip</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/tip/%E7%9F%ADURL%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E5%AE%9E%E7%8E%B0/">短URL服务的设计以及实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>转自：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903873950269454">https://juejin.cn/post/6844903873950269454</a></p>
<div class="markdown-body"><style>.markdown-body{word-break:break-word;line-height:1.75;font-weight:400;font-size:15px;overflow-x:hidden;color:#333}.markdown-body h1,.markdown-body h2,.markdown-body h3,.markdown-body h4,.markdown-body h5,.markdown-body h6{line-height:1.5;margin-top:35px;margin-bottom:10px;padding-bottom:5px}.markdown-body h1{font-size:30px;margin-bottom:5px}.markdown-body h2{padding-bottom:12px;font-size:24px;border-bottom:1px solid #ececec}.markdown-body h3{font-size:18px;padding-bottom:0}.markdown-body h4{font-size:16px}.markdown-body h5{font-size:15px}.markdown-body h6{margin-top:5px}.markdown-body p{line-height:inherit;margin-top:22px;margin-bottom:22px}.markdown-body img{max-width:100%}.markdown-body hr{border:none;border-top:1px solid #ddd;margin-top:32px;margin-bottom:32px}.markdown-body code{word-break:break-word;border-radius:2px;overflow-x:auto;background-color:#fff5f5;color:#ff502c;font-size:.87em;padding:.065em .4em}.markdown-body code,.markdown-body pre{font-family:Menlo,Monaco,Consolas,Courier New,monospace}.markdown-body pre{overflow:auto;position:relative;line-height:1.75}.markdown-body pre>code{font-size:12px;padding:15px 12px;margin:0;word-break:normal;display:block;overflow-x:auto;color:#333;background:#f8f8f8}.markdown-body a{text-decoration:none;color:#0269c8;border-bottom:1px solid #d1e9ff}.markdown-body a:active,.markdown-body a:hover{color:#275b8c}.markdown-body table{display:inline-block!important;font-size:12px;width:auto;max-width:100%;overflow:auto;border:1px solid #f6f6f6}.markdown-body thead{background:#f6f6f6;color:#000;text-align:left}.markdown-body tr:nth-child(2n){background-color:#fcfcfc}.markdown-body td,.markdown-body th{padding:12px 7px;line-height:24px}.markdown-body td{min-width:120px}.markdown-body blockquote{color:#666;padding:1px 23px;margin:22px 0;border-left:4px solid #cbcbcb;background-color:#f8f8f8}.markdown-body blockquote:after{display:block;content:""}.markdown-body blockquote>p{margin:10px 0}.markdown-body ol,.markdown-body ul{padding-left:28px}.markdown-body ol li,.markdown-body ul li{margin-bottom:0;list-style:inherit}.markdown-body ol li .task-list-item,.markdown-body ul li .task-list-item{list-style:none}.markdown-body ol li .task-list-item ol,.markdown-body ol li .task-list-item ul,.markdown-body ul li .task-list-item ol,.markdown-body ul li .task-list-item ul{margin-top:0}.markdown-body ol ol,.markdown-body ol ul,.markdown-body ul ol,.markdown-body ul ul{margin-top:3px}.markdown-body ol li{padding-left:6px}@media (max-width:720px){.markdown-body h1{font-size:24px}.markdown-body h2{font-size:20px}.markdown-body h3{font-size:18px}}</style><h2 class="heading" data-id="heading-0">目录</h2>
<ul>
<li><a href="#%E7%9B%AE%E5%BD%95">目录</a></li>
<li><a href="#%E5%89%8D%E8%A8%80">前言</a></li>
<li><a href="#%E7%9F%ADurl%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86">短URL基础原理</a></li>
<li><a href="#%E6%9C%8D%E5%8A%A1%E8%AE%BE%E8%AE%A1">服务设计</a>
- <a href="#%E5%AF%B9%E5%BA%94%E5%85%B3%E7%B3%BB%E5%A6%82%E4%BD%95%E5%AD%98%E5%82%A8">对应关系如何存储?</a>
- <a href="#%E5%A6%82%E4%BD%95%E4%BF%9D%E8%AF%81%E9%95%BF%E7%9F%AD%E9%93%BE%E6%8E%A5%E4%B8%80%E4%B8%80%E5%AF%B9%E5%BA%94">如何保证长短链接一一对应?</a>
- <a href="#%E7%9F%ADurl%E7%9A%84%E5%AD%98%E5%82%A8">短URL的存储</a>
- <a href="#%E9%AB%98%E5%B9%B6%E5%8F%91">高并发</a>
- <a href="#%E5%88%86%E5%B8%83%E5%BC%8F">分布式</a></li>
<li><a href="#%E5%AE%9E%E7%8E%B0">实现</a></li>
</ul>
<h2 class="heading" data-id="heading-1">前言</h2>
<p>想必大家也经常收到垃圾短信吧...短信中的链接一般都是短链接,类似于下图这样:</p>
<p></p><figure><img alt="2019-06-23-23-46-53" class="lazyload inited loaded" data-src="https://user-gold-cdn.xitu.io/2019/6/24/16b8a1c733274b37?imageView2/0/w/1280/h/960/format/webp/ignore-error/1" data-width="890" data-height="352" src="https://user-gold-cdn.xitu.io/2019/6/24/16b8a1c733274b37?imageView2/0/w/1280/h/960/format/webp/ignore-error/1"><figcaption></figcaption></figure><p></p>
<p>为什么这里面的url都是短的呢?有什么好处呢?怎么做到的呢?</p>
<p>短url的好处有:</p>
<ol>
<li>短. 短信和许多平台(微博)有字数限制,太长的链接加进去都没有办法写正文了.</li>
<li>好看. 比起一大堆不知所以的参数,短链接更加简洁友好.</li>
<li>方便做一些统计.你点了链接会有人记录然后分析的.</li>
<li>安全. 不暴露访问参数.</li>
</ol>
<p>这就是为什么我们现在收到的垃圾短信大多数都是短URL的原因了.</p>
<p>那么短URL是怎么做到的呢?</p>
<h2 class="heading" data-id="heading-2">短URL基础原理</h2>
<p>短URL从生成到使用分为以下几步.</p>
<ol>
<li>有一个服务,将要发送给你的长URL对应到一个短URL上.例如<code>www.baidu.com -&gt; www.t.cn/1</code></li>
<li>把短url拼接到短信等的内容上发送.</li>
<li>用户点击短URL,浏览器用301/302进行重定向,访问到对应的长URL.</li>
<li>展示对应的内容.</li>
</ol>
<p>本文主要集中于第一步,即如何将一个长URL对应到短URL上.</p>
<h2 class="heading" data-id="heading-3">服务设计</h2>
<p>如果你在往长短URL真实的对应关系上想,那么就走远了.</p>
<p>最理想的情况是: 我们用一种算法,对每一个长URL,唯一的转换成短URL.还能保持反向转换的能力.</p>
<p>但是这是不可能的,如果有这样的算法,世界上的所有压缩算法都可以原地去世了.</p>
<p>正确的思路是建立一个发号器,每次有一个新的长URL进来,我们就增加一,并且将新的数值返回.第一个来的url返回"www.x.cn/0",第二个返回"www.x.cn/1".</p>
<p>接下来以QA形式写几个小问题:</p>
<h4 class="heading" data-id="heading-4">对应关系如何存储?</h4>
<p>这个对应数据肯定是要落盘的,不能每次系统重启就重新排号,所以可以采用mysql等数据库来存储.而且如果数据量小且qps低,直接使用数据库的自增主键就可以实现.</p>
<h4 class="heading" data-id="heading-5">如何保证长短链接一一对应?</h4>
<p>按照上面的发号器策略,是不能保证长短链接的一一对应的,你连续用同一个URL请求两次,结果值都是不一样的.</p>
<p>为了实现长短链接一一对应,我们需要付出很大的空间代价,尤其是为了快速响应,我们可以需要在内存中做一层缓存,这样子太浪费了.</p>
<p>但是可以实现一些变种的,来实现部分的一一对应, 比如将最近/最热门的对应关系存储在K-V数据库中,这样子可以节省空间的同时,加快响应速度.</p>
<h4 class="heading" data-id="heading-6">短URL的存储</h4>
<p>我们返回的短URL一般是将数字转换成32进制,这样子可以更加有效的缩短URL长度,那么32进制的数字对计算机来说只是字符串,怎么存储呢?直接存储字符串对等值查找好找,对范围查找等太不友好了.</p>
<p>其实可以直接存储10进制的数字,这样不仅占用空间少,对查找的支持较好,同时还可以更加方便的转换到更多/更少的进制来进一步缩短URL.</p>
<h4 class="heading" data-id="heading-7">高并发</h4>
<p>如果直接存储在MySQL中,当并发请求增大,对数据库的压力太大,可能会造成瓶颈,这时候是可以有一些优化的.</p>
<p><strong>缓存</strong></p>
<p>上面<em>保证长短链接一一对应</em>中也提到过缓存,这里我们是为了加快程序处理速度.可以将热门的长链接(需要对长链接进来的次数进行计数),最近的长链接(可以使用redis保存最近一个小时的)等等进行一个缓存,保存在内存中或者类似redis的内存数据库中,如果请求的长URL命中了缓存,那么直接获取对应的短URL进行返回,不需要再进行生成操作.</p>
<p><strong>批量发号</strong></p>
<p>每一次发号都需要访问一次MySQL来获取当前的最大号码,并且在获取之后更新最大号码,这个压力是比较大的.</p>
<p>我们可以每次从数据库获取10000个号码,然后在内存中进行发放,当剩余的号码不足1000时,重新向MySQL请求下10000个号码.在上一批号码发放完了之后,批量进行写入.</p>
<p>这样可以将对数据库持续的操作移到代码中进行,并且异步进行获取和写入操作,保证服务的持续高并发.</p>
<h4 class="heading" data-id="heading-8">分布式</h4>
<p>上面设计的系统是有单点的,那就是发号器是个单点,容易挂掉.</p>
<p>可以采用分布式服务,分布式的话,如果每一个发号器进行发号之后都需要同步给其他发号器,那未必也太麻烦了.</p>
<p>换一种思路,可以有两个发号器,一个发单号,一个发双号,发号之后不再是递增1,而是递增2.</p>
<p>类比可得,我们可以用1000个服务,分别发放0-999尾号的数字,每次发号之后递增1000.这样做很简单,服务互相之间基本都不用通信,做好自己的事情就好了.</p>
<h2 class="heading" data-id="heading-9">实现</h2>
<p>由于我懒得写JDBC代码,更懒得弄Mybatis,所以代码中使用到MySQL的地方都使用了Redis.</p>
<pre><code class="hljs java copyable" lang="java"><span class="hljs-keyword">package</span> util;

<p><span class="hljs-keyword">import</span> redis.clients.jedis.Jedis;</p>
<p><span class="hljs-comment">/**</p>
<ul>
<li>Created by pfliu on 2019/06/23.</li>
<li>/</span><br><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">ShortUrlUtil</span> </span>&#123;</li>
</ul>
<pre><code>&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; String SHORT_URL_KEY = &lt;span class=&quot;hljs-string&quot;&gt;&quot;SHORT_URL_KEY&quot;&lt;/span&gt;;
&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; String LOCALHOST = &lt;span class=&quot;hljs-string&quot;&gt;&quot;http://localhost:4444/&quot;&lt;/span&gt;;
&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; String SHORT_LONG_PREFIX = &lt;span class=&quot;hljs-string&quot;&gt;&quot;short_long_prefix_&quot;&lt;/span&gt;;
&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; String CACHE_KEY_PREFIX = &lt;span class=&quot;hljs-string&quot;&gt;&quot;cache_key_prefix_&quot;&lt;/span&gt;;
&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; CACHE_SECONDS = &lt;span class=&quot;hljs-number&quot;&gt;1&lt;/span&gt; * &lt;span class=&quot;hljs-number&quot;&gt;60&lt;/span&gt; * &lt;span class=&quot;hljs-number&quot;&gt;60&lt;/span&gt;;

&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; String redisConfig;
&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; Jedis jedis;

&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;ShortUrlUtil&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String redisConfig)&lt;/span&gt; &lt;/span&gt;&#123;
    &lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;.redisConfig = redisConfig;
    &lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;.jedis = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; Jedis(&lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;.redisConfig);
&#125;

&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; String &lt;span class=&quot;hljs-title&quot;&gt;getShortUrl&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String longUrl, Decimal decimal)&lt;/span&gt; &lt;/span&gt;&#123;
    &lt;span class=&quot;hljs-comment&quot;&gt;// 查询缓存&lt;/span&gt;
    String cache = jedis.get(CACHE_KEY_PREFIX + longUrl);
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (cache != &lt;span class=&quot;hljs-keyword&quot;&gt;null&lt;/span&gt;) &#123;
        &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; LOCALHOST + toOtherBaseString(Long.valueOf(cache), decimal.x);
    &#125;

    &lt;span class=&quot;hljs-comment&quot;&gt;// 自增&lt;/span&gt;
    &lt;span class=&quot;hljs-keyword&quot;&gt;long&lt;/span&gt; num = jedis.incr(SHORT_URL_KEY);
    &lt;span class=&quot;hljs-comment&quot;&gt;// 在数据库中保存短-长URL的映射关系,可以保存在MySQL中&lt;/span&gt;
    jedis.set(SHORT_LONG_PREFIX + num, longUrl);
    &lt;span class=&quot;hljs-comment&quot;&gt;// 写入缓存&lt;/span&gt;
    jedis.setex(CACHE_KEY_PREFIX + longUrl, CACHE_SECONDS, String.valueOf(num));
    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; LOCALHOST + toOtherBaseString(num, decimal.x);
&#125;

&lt;span class=&quot;hljs-comment&quot;&gt;/**
 * 在进制表示中的字符集合
 */&lt;/span&gt;
&lt;span class=&quot;hljs-keyword&quot;&gt;final&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;char&lt;/span&gt;[] digits = &#123;&lt;span class=&quot;hljs-string&quot;&gt;&#39;0&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;1&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;2&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;3&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;4&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;5&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;6&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;7&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;8&#39;&lt;/span&gt;,
        &lt;span class=&quot;hljs-string&quot;&gt;&#39;9&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;A&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;B&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;C&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;D&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;E&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;F&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;G&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;H&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;I&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;J&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;K&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;L&#39;&lt;/span&gt;,
        &lt;span class=&quot;hljs-string&quot;&gt;&#39;M&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;N&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;O&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;P&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;Q&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;R&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;S&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;T&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;U&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;V&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;W&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;X&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;Y&#39;&lt;/span&gt;,
        &lt;span class=&quot;hljs-string&quot;&gt;&#39;Z&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;a&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;b&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;c&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;d&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;e&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;f&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;g&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;h&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;i&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;j&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;k&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;l&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;m&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;n&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;o&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;p&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;q&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;r&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;s&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;t&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;u&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;v&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;w&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;x&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;y&#39;&lt;/span&gt;, &lt;span class=&quot;hljs-string&quot;&gt;&#39;z&#39;&lt;/span&gt;&#125;;

&lt;span class=&quot;hljs-comment&quot;&gt;/**
 * 由10进制的数字转换到其他进制
 */&lt;/span&gt;
&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;private&lt;/span&gt; String &lt;span class=&quot;hljs-title&quot;&gt;toOtherBaseString&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(&lt;span class=&quot;hljs-keyword&quot;&gt;long&lt;/span&gt; n, &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; base)&lt;/span&gt; &lt;/span&gt;&#123;
    &lt;span class=&quot;hljs-keyword&quot;&gt;long&lt;/span&gt; num = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;;
    &lt;span class=&quot;hljs-keyword&quot;&gt;if&lt;/span&gt; (n &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) &#123;
        num = ((&lt;span class=&quot;hljs-keyword&quot;&gt;long&lt;/span&gt;) &lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt; * &lt;span class=&quot;hljs-number&quot;&gt;0x7fffffff&lt;/span&gt;) + n + &lt;span class=&quot;hljs-number&quot;&gt;2&lt;/span&gt;;
    &#125; &lt;span class=&quot;hljs-keyword&quot;&gt;else&lt;/span&gt; &#123;
        num = n;
    &#125;
    &lt;span class=&quot;hljs-keyword&quot;&gt;char&lt;/span&gt;[] buf = &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;char&lt;/span&gt;[&lt;span class=&quot;hljs-number&quot;&gt;32&lt;/span&gt;];
    &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; charPos = &lt;span class=&quot;hljs-number&quot;&gt;32&lt;/span&gt;;
    &lt;span class=&quot;hljs-keyword&quot;&gt;while&lt;/span&gt; ((num / base) &amp;gt; &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;) &#123;
        buf[--charPos] = digits[(&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt;) (num % base)];
        num /= base;
    &#125;
    buf[--charPos] = digits[(&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt;) (num % base)];
    &lt;span class=&quot;hljs-keyword&quot;&gt;return&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; String(buf, charPos, (&lt;span class=&quot;hljs-number&quot;&gt;32&lt;/span&gt; - charPos));
&#125;

&lt;span class=&quot;hljs-keyword&quot;&gt;enum&lt;/span&gt; Decimal &#123;
    D32(&lt;span class=&quot;hljs-number&quot;&gt;32&lt;/span&gt;),
    D64(&lt;span class=&quot;hljs-number&quot;&gt;64&lt;/span&gt;);

    &lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; x;

    Decimal(&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; x) &#123;
        &lt;span class=&quot;hljs-keyword&quot;&gt;this&lt;/span&gt;.x = x;
    &#125;
&#125;


&lt;span class=&quot;hljs-function&quot;&gt;&lt;span class=&quot;hljs-keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;static&lt;/span&gt; &lt;span class=&quot;hljs-keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;hljs-title&quot;&gt;main&lt;/span&gt;&lt;span class=&quot;hljs-params&quot;&gt;(String[] args)&lt;/span&gt; &lt;/span&gt;&#123;

    &lt;span class=&quot;hljs-keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;hljs-keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;hljs-number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;hljs-number&quot;&gt;100&lt;/span&gt;; i++) &#123;
        System.out.println(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; ShortUrlUtil(&lt;span class=&quot;hljs-string&quot;&gt;&quot;localhost&quot;&lt;/span&gt;).getShortUrl(&lt;span class=&quot;hljs-string&quot;&gt;&quot;www.baidudu.com&quot;&lt;/span&gt;, Decimal.D32));
        System.out.println(&lt;span class=&quot;hljs-keyword&quot;&gt;new&lt;/span&gt; ShortUrlUtil(&lt;span class=&quot;hljs-string&quot;&gt;&quot;localhost&quot;&lt;/span&gt;).getShortUrl(&lt;span class=&quot;hljs-string&quot;&gt;&quot;www.baidu.com&quot;&lt;/span&gt;, Decimal.D64));
    &#125;
&#125;</code></pre>
<p>}</p>
<p><span class="copy-code-btn">复制代码</span></code></pre><br><br>完。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/tip/%E7%9F%ADURL%E6%9C%8D%E5%8A%A1%E7%9A%84%E8%AE%BE%E8%AE%A1%E4%BB%A5%E5%8F%8A%E5%AE%9E%E7%8E%B0/" data-id="cki5ye6tc000ri4xvb4wo55ql" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/tip/" rel="tag">tip</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-tip/优雅地处理重复请求" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/PersonalBlog/2020/11/30/tip/%E4%BC%98%E9%9B%85%E5%9C%B0%E5%A4%84%E7%90%86%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82/" class="article-date">
  <time datetime="2020-11-29T16:00:00.000Z" itemprop="datePublished">2020-11-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/PersonalBlog/categories/tip/">tip</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/PersonalBlog/2020/11/30/tip/%E4%BC%98%E9%9B%85%E5%9C%B0%E5%A4%84%E7%90%86%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82/">优雅地处理重复请求</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <article class="hentry" role="article">

<p> 转自：<a target="_blank" rel="noopener" href="http://jaskey.github.io/blog/2020/05/19/handle-duplicate-request/">http://jaskey.github.io/blog/2020/05/19/handle-duplicate-request/</a></p>
<div class="entry-content"><p>对于一些用户请求，在某些情况下是可能重复发送的，如果是查询类操作并无大碍，但其中有些是涉及写入操作的，一旦重复了，可能会导致很严重的后果，例如交易的接口如果重复请求可能会重复下单。</p>

<p>重复的场景有可能是：</p>

<ol>
<li>黑客拦截了请求，重放</li>
<li>前端/客户端因为某些原因请求重复发送了，或者用户在很短的时间内重复点击了。</li>
<li>网关重发</li>
<li>….</li>
</ol>


<p>本文讨论的是如果在服务端优雅地统一处理这种情况，如何禁止用户重复点击等客户端操作不在本文的讨论范畴。</p>

<h2>利用唯一请求编号去重</h2>

<p>你可能会想到的是，只要请求有唯一的请求编号，那么就能借用Redis做这个去重——只要这个唯一请求编号在redis存在，证明处理过，那么就认为是重复的</p>

<p>代码大概如下：</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">    <span class="n">String</span> <span class="n">KEY</span> <span class="o">=</span> <span class="s">"REQ12343456788"</span><span class="o">;</span><span class="c1">//请求唯一编号</span>
</span><span class="line">    <span class="kt">long</span> <span class="n">expireTime</span> <span class="o">=</span>  <span class="mi">1000</span><span class="o">;</span><span class="c1">// 1000毫秒过期，1000ms内的重复请求会认为重复</span>
</span><span class="line">    <span class="kt">long</span> <span class="n">expireAt</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">expireTime</span><span class="o">;</span>
</span><span class="line">    <span class="n">String</span> <span class="n">val</span> <span class="o">=</span> <span class="s">"expireAt@"</span> <span class="o">+</span> <span class="n">expireAt</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="c1">//redis key还存在的话要就认为请求是重复的</span>
</span><span class="line">    <span class="n">Boolean</span> <span class="n">firstSet</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">((</span><span class="n">RedisCallback</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;)</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">connection</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">KEY</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">val</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Expiration</span><span class="o">.</span><span class="na">milliseconds</span><span class="o">(</span><span class="n">expireTime</span><span class="o">),</span> <span class="n">RedisStringCommands</span><span class="o">.</span><span class="na">SetOption</span><span class="o">.</span><span class="na">SET_IF_ABSENT</span><span class="o">));</span>
</span><span class="line">
</span><span class="line">    <span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isConsiderDup</span><span class="o">;</span>
</span><span class="line">    <span class="k">if</span> <span class="o">(</span><span class="n">firstSet</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">firstSet</span><span class="o">)</span> <span class="o">&#123;</span><span class="c1">// 第一次访问</span>
</span><span class="line">        <span class="n">isConsiderDup</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line">    <span class="o">&#125;</span> <span class="k">else</span> <span class="o">&#123;</span><span class="c1">// redis值已存在，认为是重复了</span>
</span><span class="line">        <span class="n">isConsiderDup</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line">    <span class="o">&#125;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<h2>业务参数去重</h2>

<p>上面的方案能解决具备唯一请求编号的场景，例如每次写请求之前都是服务端返回一个唯一编号给客户端，客户端带着这个请求号做请求，服务端即可完成去重拦截。</p>

<p>但是，很多的场景下，请求并不会带这样的唯一编号！那么我们能否针对请求的参数作为一个请求的标识呢？</p>

<p>先考虑简单的场景，假设请求参数只有一个字段reqParam，我们可以利用以下标识去判断这个请求是否重复。 <strong>用户ID:接口名:请求参数</strong></p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">String</span> <span class="n">KEY</span> <span class="o">=</span> <span class="s">"dedup:U="</span><span class="o">+</span><span class="n">userId</span> <span class="o">+</span> <span class="s">"M="</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="s">"P="</span> <span class="o">+</span> <span class="n">reqParam</span><span class="o">;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>那么当同一个用户访问同一个接口，带着同样的reqParam过来，我们就能定位到他是重复的了。</p>

<p>但是问题是，我们的接口通常不是这么简单，以目前的主流，我们的参数通常是一个JSON。那么针对这种场景，我们怎么去重呢？</p>

<h3>计算请求参数的摘要作为参数标识</h3>

<p>假设我们把请求参数（JSON）按KEY做升序排序，排序后拼成一个字符串，作为KEY值呢？但这可能非常的长，所以我们可以考虑对这个字符串求一个MD5作为参数的摘要，以这个摘要去取代reqParam的位置。</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">String</span> <span class="n">KEY</span> <span class="o">=</span> <span class="s">"dedup:U="</span><span class="o">+</span><span class="n">userId</span> <span class="o">+</span> <span class="s">"M="</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="s">"P="</span> <span class="o">+</span> <span class="n">reqParamMD5</span><span class="o">;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>这样，请求的唯一标识就打上了！</p>

<p>注：MD5理论上可能会重复，但是去重通常是短时间窗口内的去重（例如一秒），一个短时间内同一个用户同样的接口能拼出不同的参数导致一样的MD5几乎是不可能的。</p>

<h3>继续优化，考虑剔除部分时间因子</h3>

<p>上面的问题其实已经是一个很不错的解决方案了，但是实际投入使用的时候可能发现有些问题：某些请求用户短时间内重复的点击了（例如1000毫秒发送了三次请求），但绕过了上面的去重判断（不同的KEY值）。</p>

<p>原因是这些请求参数的字段里面，<strong>是带时间字段的</strong>，这个字段标记用户请求的时间，服务端可以借此丢弃掉一些老的请求（例如5秒前）。如下面的例子，请求的其他参数是一样的，除了请求时间相差了一秒：</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</pre></td><td class="code"><pre><code class="java"><span class="line">    <span class="c1">//两个请求一样，但是请求时间差一秒</span>
</span><span class="line">    <span class="n">String</span> <span class="n">req</span> <span class="o">=</span> <span class="s">"&#123;\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestTime\" :\"20190101120001\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestValue\" :\"1000\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestKey\" :\"key\"\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"&#125;"</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">String</span> <span class="n">req2</span> <span class="o">=</span> <span class="s">"&#123;\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestTime\" :\"20190101120002\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestValue\" :\"1000\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestKey\" :\"key\"\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"&#125;"</span><span class="o">;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>这种请求，我们也很可能需要挡住后面的重复请求。所以求业务参数摘要之前，需要剔除这类时间字段。还有类似的字段可能是GPS的经纬度字段（重复请求间可能有极小的差别）。</p>

<h2>请求去重工具类，Java实现</h2>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
<span class="line-number">26</span>
<span class="line-number">27</span>
<span class="line-number">28</span>
<span class="line-number">29</span>
<span class="line-number">30</span>
<span class="line-number">31</span>
<span class="line-number">32</span>
<span class="line-number">33</span>
<span class="line-number">34</span>
<span class="line-number">35</span>
<span class="line-number">36</span>
<span class="line-number">37</span>
<span class="line-number">38</span>
<span class="line-number">39</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">class</span> <span class="nc">ReqDedupHelper</span> <span class="o">&#123;</span>
</span><span class="line">
</span><span class="line">    <span class="cm">/**</span>
</span><span class="line"><span class="cm">     *</span>
</span><span class="line"><span class="cm">     * @param reqJSON 请求的参数，这里通常是JSON</span>
</span><span class="line"><span class="cm">     * @param excludeKeys 请求参数里面要去除哪些字段再求摘要</span>
</span><span class="line"><span class="cm">     * @return 去除参数的MD5摘要</span>
</span><span class="line"><span class="cm">     */</span>
</span><span class="line">    <span class="kd">public</span> <span class="n">String</span> <span class="nf">dedupParamMD5</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">reqJSON</span><span class="o">,</span> <span class="n">String</span><span class="o">...</span> <span class="n">excludeKeys</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">        <span class="n">String</span> <span class="n">decreptParam</span> <span class="o">=</span> <span class="n">reqJSON</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">        <span class="n">TreeMap</span> <span class="n">paramTreeMap</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">parseObject</span><span class="o">(</span><span class="n">decreptParam</span><span class="o">,</span> <span class="n">TreeMap</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
</span><span class="line">        <span class="k">if</span> <span class="o">(</span><span class="n">excludeKeys</span><span class="o">!=</span><span class="kc">null</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">            <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">dedupExcludeKeys</span> <span class="o">=</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="n">excludeKeys</span><span class="o">);</span>
</span><span class="line">            <span class="k">if</span> <span class="o">(!</span><span class="n">dedupExcludeKeys</span><span class="o">.</span><span class="na">isEmpty</span><span class="o">())</span> <span class="o">&#123;</span>
</span><span class="line">                <span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">dedupExcludeKey</span> <span class="o">:</span> <span class="n">dedupExcludeKeys</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">                    <span class="n">paramTreeMap</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">dedupExcludeKey</span><span class="o">);</span>
</span><span class="line">                <span class="o">&#125;</span>
</span><span class="line">            <span class="o">&#125;</span>
</span><span class="line">        <span class="o">&#125;</span>
</span><span class="line">
</span><span class="line">        <span class="n">String</span> <span class="n">paramTreeMapJSON</span> <span class="o">=</span> <span class="n">JSON</span><span class="o">.</span><span class="na">toJSONString</span><span class="o">(</span><span class="n">paramTreeMap</span><span class="o">);</span>
</span><span class="line">        <span class="n">String</span> <span class="n">md5deDupParam</span> <span class="o">=</span> <span class="n">jdkMD5</span><span class="o">(</span><span class="n">paramTreeMapJSON</span><span class="o">);</span>
</span><span class="line">        <span class="n">log</span><span class="o">.</span><span class="na">debug</span><span class="o">(</span><span class="s">"md5deDupParam = &#123;&#125;, excludeKeys = &#123;&#125; &#123;&#125;"</span><span class="o">,</span> <span class="n">md5deDupParam</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">deepToString</span><span class="o">(</span><span class="n">excludeKeys</span><span class="o">),</span> <span class="n">paramTreeMapJSON</span><span class="o">);</span>
</span><span class="line">        <span class="k">return</span> <span class="n">md5deDupParam</span><span class="o">;</span>
</span><span class="line">    <span class="o">&#125;</span>
</span><span class="line">
</span><span class="line">    <span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">jdkMD5</span><span class="o">(</span><span class="n">String</span> <span class="n">src</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">        <span class="n">String</span> <span class="n">res</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
</span><span class="line">        <span class="k">try</span> <span class="o">&#123;</span>
</span><span class="line">            <span class="n">MessageDigest</span> <span class="n">messageDigest</span> <span class="o">=</span> <span class="n">MessageDigest</span><span class="o">.</span><span class="na">getInstance</span><span class="o">(</span><span class="s">"MD5"</span><span class="o">);</span>
</span><span class="line">            <span class="kt">byte</span><span class="o">[]</span> <span class="n">mdBytes</span> <span class="o">=</span> <span class="n">messageDigest</span><span class="o">.</span><span class="na">digest</span><span class="o">(</span><span class="n">src</span><span class="o">.</span><span class="na">getBytes</span><span class="o">());</span>
</span><span class="line">            <span class="n">res</span> <span class="o">=</span> <span class="n">DatatypeConverter</span><span class="o">.</span><span class="na">printHexBinary</span><span class="o">(</span><span class="n">mdBytes</span><span class="o">);</span>
</span><span class="line">        <span class="o">&#125;</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">            <span class="n">log</span><span class="o">.</span><span class="na">error</span><span class="o">(</span><span class="s">""</span><span class="o">,</span><span class="n">e</span><span class="o">);</span>
</span><span class="line">        <span class="o">&#125;</span>
</span><span class="line">        <span class="k">return</span> <span class="n">res</span><span class="o">;</span>
</span><span class="line">    <span class="o">&#125;</span>
</span><span class="line"><span class="o">&#125;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>下面是一些测试日志：</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
<span class="line-number">20</span>
<span class="line-number">21</span>
<span class="line-number">22</span>
<span class="line-number">23</span>
<span class="line-number">24</span>
<span class="line-number">25</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">    <span class="c1">//两个请求一样，但是请求时间差一秒</span>
</span><span class="line">    <span class="n">String</span> <span class="n">req</span> <span class="o">=</span> <span class="s">"&#123;\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestTime\" :\"20190101120001\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestValue\" :\"1000\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestKey\" :\"key\"\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"&#125;"</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="n">String</span> <span class="n">req2</span> <span class="o">=</span> <span class="s">"&#123;\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestTime\" :\"20190101120002\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestValue\" :\"1000\",\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"\"requestKey\" :\"key\"\n"</span> <span class="o">+</span>
</span><span class="line">            <span class="s">"&#125;"</span><span class="o">;</span>
</span><span class="line">
</span><span class="line">    <span class="c1">//全参数比对，所以两个参数MD5不同</span>
</span><span class="line">    <span class="n">String</span> <span class="n">dedupMD5</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ReqDedupHelper</span><span class="o">().</span><span class="na">dedupParamMD5</span><span class="o">(</span><span class="n">req</span><span class="o">);</span>
</span><span class="line">    <span class="n">String</span> <span class="n">dedupMD52</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ReqDedupHelper</span><span class="o">().</span><span class="na">dedupParamMD5</span><span class="o">(</span><span class="n">req2</span><span class="o">);</span>
</span><span class="line">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"req1MD5 = "</span><span class="o">+</span> <span class="n">dedupMD5</span><span class="o">+</span><span class="s">" , req2MD5="</span><span class="o">+</span><span class="n">dedupMD52</span><span class="o">);</span>
</span><span class="line">
</span><span class="line">    <span class="c1">//去除时间参数比对，MD5相同</span>
</span><span class="line">    <span class="n">String</span> <span class="n">dedupMD53</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ReqDedupHelper</span><span class="o">().</span><span class="na">dedupParamMD5</span><span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="s">"requestTime"</span><span class="o">);</span>
</span><span class="line">    <span class="n">String</span> <span class="n">dedupMD54</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ReqDedupHelper</span><span class="o">().</span><span class="na">dedupParamMD5</span><span class="o">(</span><span class="n">req2</span><span class="o">,</span><span class="s">"requestTime"</span><span class="o">);</span>
</span><span class="line">    <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"req1MD5 = "</span><span class="o">+</span> <span class="n">dedupMD53</span><span class="o">+</span><span class="s">" , req2MD5="</span><span class="o">+</span><span class="n">dedupMD54</span><span class="o">);</span>
</span><span class="line">
</span><span class="line"><span class="o">&#125;</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>日志输出：</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">req1MD5</span> <span class="o">=</span> <span class="mi">9</span><span class="n">E054D36439EBDD0604C5E65EB5C8267</span> <span class="o">,</span> <span class="n">req2MD5</span><span class="o">=</span><span class="n">A2D20BAC78551C4CA09BEF97FE468A3F</span>
</span><span class="line"><span class="n">req1MD5</span> <span class="o">=</span> <span class="n">C2A36FED15128E9E878583CAAAFEFDE9</span> <span class="o">,</span> <span class="n">req2MD5</span><span class="o">=</span><span class="n">C2A36FED15128E9E878583CAAAFEFDE9</span>
</span></code></pre></td></tr></tbody></table></div></figure>


<p>日志说明：</p>

<ul>
<li>一开始两个参数由于requestTime是不同的，所以求去重参数摘要的时候可以发现两个值是不一样的</li>
<li>第二次调用的时候，去除了requestTime再求摘要（第二个参数中传入了”requestTime”），则发现两个摘要是一样的，符合预期。</li>
</ul>


<h2>总结</h2>

<p>至此，我们可以得到完整的去重解决方案，如下：</p>

<figure class="code"><figcaption><span></span></figcaption><div class="highlight"><table><tbody><tr><td class="gutter"><pre class="line-numbers"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</pre></td><td class="code"><pre><code class="java"><span class="line"><span class="n">String</span> <span class="n">userId</span><span class="o">=</span> <span class="s">"12345678"</span><span class="o">;</span><span class="c1">//用户</span>
</span><span class="line"><span class="n">String</span> <span class="n">method</span> <span class="o">=</span> <span class="s">"pay"</span><span class="o">;</span><span class="c1">//接口名</span>
</span><span class="line"><span class="n">String</span> <span class="n">dedupMD5</span> <span class="o">=</span> <span class="k">new</span> <span class="nf">ReqDedupHelper</span><span class="o">().</span><span class="na">dedupParamMD5</span><span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="s">"requestTime"</span><span class="o">);</span><span class="c1">//计算请求参数摘要，其中剔除里面请求时间的干扰</span>
</span><span class="line"><span class="n">String</span> <span class="n">KEY</span> <span class="o">=</span> <span class="s">"dedup:U="</span> <span class="o">+</span> <span class="n">userId</span> <span class="o">+</span> <span class="s">"M="</span> <span class="o">+</span> <span class="n">method</span> <span class="o">+</span> <span class="s">"P="</span> <span class="o">+</span> <span class="n">dedupMD5</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="kt">long</span> <span class="n">expireTime</span> <span class="o">=</span>  <span class="mi">1000</span><span class="o">;</span><span class="c1">// 1000毫秒过期，1000ms内的重复请求会认为重复</span>
</span><span class="line"><span class="kt">long</span> <span class="n">expireAt</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">expireTime</span><span class="o">;</span>
</span><span class="line"><span class="n">String</span> <span class="n">val</span> <span class="o">=</span> <span class="s">"expireAt@"</span> <span class="o">+</span> <span class="n">expireAt</span><span class="o">;</span>
</span><span class="line">
</span><span class="line"><span class="c1">// NOTE:直接SETNX不支持带过期时间，所以设置+过期不是原子操作，极端情况下可能设置了就不过期了，后面相同请求可能会误以为需要去重，所以这里使用底层API，保证SETNX+过期时间是原子操作</span>
</span><span class="line"><span class="n">Boolean</span> <span class="n">firstSet</span> <span class="o">=</span> <span class="n">stringRedisTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">((</span><span class="n">RedisCallback</span><span class="o">&lt;</span><span class="n">Boolean</span><span class="o">&gt;)</span> <span class="n">connection</span> <span class="o">-&gt;</span> <span class="n">connection</span><span class="o">.</span><span class="na">set</span><span class="o">(</span><span class="n">KEY</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">val</span><span class="o">.</span><span class="na">getBytes</span><span class="o">(),</span> <span class="n">Expiration</span><span class="o">.</span><span class="na">milliseconds</span><span class="o">(</span><span class="n">expireTime</span><span class="o">),</span>
</span><span class="line">        <span class="n">RedisStringCommands</span><span class="o">.</span><span class="na">SetOption</span><span class="o">.</span><span class="na">SET_IF_ABSENT</span><span class="o">));</span>
</span><span class="line">
</span><span class="line"><span class="kd">final</span> <span class="kt">boolean</span> <span class="n">isConsiderDup</span><span class="o">;</span>
</span><span class="line"><span class="k">if</span> <span class="o">(</span><span class="n">firstSet</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">firstSet</span><span class="o">)</span> <span class="o">&#123;</span>
</span><span class="line">    <span class="n">isConsiderDup</span> <span class="o">=</span> <span class="kc">false</span><span class="o">;</span>
</span><span class="line"><span class="o">&#125;</span> <span class="k">else</span> <span class="o">&#123;</span>
</span><span class="line">    <span class="n">isConsiderDup</span> <span class="o">=</span> <span class="kc">true</span><span class="o">;</span>
</span><span class="line"><span class="o">&#125;</span>
</span></code></pre></td></tr></tbody></table></div></figure>




  <footer>
    <p class="meta"></article>
      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2020/11/30/tip/%E4%BC%98%E9%9B%85%E5%9C%B0%E5%A4%84%E7%90%86%E9%87%8D%E5%A4%8D%E8%AF%B7%E6%B1%82/" data-id="cki5ye6td000ti4xvehx3b1mc" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/PersonalBlog/tags/tip/" rel="tag">tip</a></li></ul>

    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/PersonalBlog/categories/algorithm/">algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/PersonalBlog/categories/review/">review</a></li><li class="category-list-item"><a class="category-list-link" href="/PersonalBlog/categories/tip/">tip</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/PersonalBlog/tags/algorithm/" rel="tag">algorithm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/PersonalBlog/tags/review/" rel="tag">review</a></li><li class="tag-list-item"><a class="tag-list-link" href="/PersonalBlog/tags/tip/" rel="tag">tip</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/PersonalBlog/tags/algorithm/" style="font-size: 10px;">algorithm</a> <a href="/PersonalBlog/tags/review/" style="font-size: 10px;">review</a> <a href="/PersonalBlog/tags/tip/" style="font-size: 20px;">tip</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/PersonalBlog/archives/2020/11/">November 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/PersonalBlog/2020/11/30/hello-world/">Hello World</a>
          </li>
        
          <li>
            <a href="/PersonalBlog/2020/11/30/tip/MyBatis%E5%A6%82%E4%BD%95%E5%AE%9E%E7%8E%B0%E6%B5%81%E5%BC%8F%E6%9F%A5%E8%AF%A2/">MyBatis如何实现流式查询</a>
          </li>
        
          <li>
            <a href="/PersonalBlog/2020/11/30/algorithm/MaximumGap/">MaximumGap</a>
          </li>
        
          <li>
            <a href="/PersonalBlog/2020/11/30/algorithm/MoveZeroes/">MoveZeroes</a>
          </li>
        
          <li>
            <a href="/PersonalBlog/2020/11/30/review/Java11%20Api%20Document/1.%20Java%C2%AE%20Platform,%20Standard%20Edition%20&%20Java%20Development%20Kit%20Version%2011%20API%20Specification/">1. Java® Platform, Standard Edition &amp; Java Development Kit Version 11 API Specification</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 John Doe<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/PersonalBlog/" class="mobile-nav-link">Home</a>
  
    <a href="/PersonalBlog/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/PersonalBlog/fancybox/jquery.fancybox.css">

  
<script src="/PersonalBlog/fancybox/jquery.fancybox.pack.js"></script>




<script src="/PersonalBlog/js/script.js"></script>




  </div>
</body>
</html>